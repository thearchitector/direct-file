# MeF Submission Pipeline

## What Is MeF?

The **Modernized e-File (MeF)** system is the IRS's electronic filing infrastructure. It is a SOAP/WSDL-based web service that accepts tax returns in XML format and returns acceptance or rejection statuses. MeF has been available for authorized public use since the early 2000s.

DirectFile submits returns directly to MeF, just as commercial tax software (TurboTax, H&R Block, etc.) does. The key difference is that DirectFile is operated by the IRS itself.

## Key Identifiers in the Submission Lifecycle

Understanding these identifiers is essential for tracing a return through the system:

| Identifier | Generated By | Purpose | Example |
|-----------|-------------|---------|---------|
| **Tax Return ID** | DirectFile Backend | Identifies the entire experience for one taxpayer, one tax year. Stays the same across resubmissions. | `4638655a-5798-4174-a5a0-37cc3b3cd9a0` |
| **MeF Submission ID** | DirectFile Backend | Identifies each individual submission attempt. New ID for each resubmission. | `55555620230215000001` |
| **Receipt ID** | MeF | Confirms MeF received the submission. If no receipt ID exists, MeF didn't receive it. | `2d59a07d-57ef-4392-8196-48ac29dce023` |
| **Acknowledgement** | MeF | The processed result: accepted or rejected. Associates with a Submission ID and Receipt ID. | Status: `accepted` or `rejected` with error codes |

## The Submission Flow: Step by Step

### Step 1: User Clicks "Submit"
The frontend calls `POST /taxreturn/{taxReturnId}/submit`.

### Step 2: Backend Processes the Submission
The Backend API (`direct-file-api` container):
1. Loads the user's encrypted fact graph from the database
2. Decrypts it using the data encryption key (via KMS)
3. Initializes a JVM-side fact graph instance from the JSON
4. Re-derives all computed facts to ensure values are authoritative
5. Validates that all required facts are complete
6. Generates the **MeF Submission ID** (a 20-character string with a specific format including EFIN and variable characters)

### Step 3: XML Generation
The backend converts the fact graph into MeF-compliant XML:
1. Reads fact values from the JVM-side fact graph
2. Maps facts to the appropriate XML elements per the MeF schema
3. Only exported facts (with `<Export mef="true" />`) are available for XML generation
4. Facts with zero values are omitted unless `<ExportZero/>` is specified
5. The XML includes the main 1040 form plus all applicable schedules and supporting forms

### Step 4: XML Validation
The generated XML is validated against the MeF XML schema:
- This is a critical step — XML content validation failure is a common cause of local submission failures
- The schema defines the exact structure, data types, and constraints for every element
- If validation fails, the submission is aborted and the error is logged

### Step 5: Artifact Storage
If validation succeeds:
1. The XML is encrypted using the S3 Encryption Client
2. The encrypted XML is uploaded to S3 at a path like: `2024/taxreturns/{taxReturnId}/submissions/{submissionId}.xml`
3. A JSON version of the submission data is also stored
4. A PDF rendering of the return may also be generated and stored
5. A snapshot of the fact graph at submission time is stored in the `taxreturn_submissions` table (immutable)

### Step 6: Queue Dispatch
A message is placed on the **dispatch queue** (SQS) containing:
- The tax return ID
- The submission ID
- The S3 location of the XML file

### Step 7: MeF Submit Service Picks Up the Message
The **MeF Submit service** (`mef-submit` container):
1. Reads the message from the dispatch queue
2. Retrieves the XML from S3
3. Submits the XML to the MeF SOAP web service
4. MeF returns a **Receipt ID** confirming receipt
5. The submit service logs: "Successfully Submitted 1 submissions for batch..."

### Step 8: Notifications
After successful submission to MeF, the submit service sends notifications:
1. **submission-confirmation-queue**: Tells the Backend API that the submission was sent. The backend reads this and updates the database.
2. **pending-submission-queue**: Tells the Status service that this submission needs to be polled for an acknowledgement.

### Step 9: Status Polling
The **MeF Status service** (`mef-status` container):
1. Reads from the pending-submission-queue
2. Periodically polls MeF for acknowledgements
3. When MeF processes the submission, it returns either:
   - **Accepted**: The return was accepted by the IRS
   - **Rejected**: The return was rejected, with one or more error codes explaining why

### Step 10: Status Propagation
When the Status service receives an acknowledgement:
1. Writes to the **status-change-queue** (SQS)
2. The Backend API reads this message and:
   - Creates a new `SubmissionEvent` record in the database (append-only audit log)
   - Caches the status in Redis for fast retrieval
   - Updates the tax return's overall status

### Step 11: User Sees the Result
The frontend polls the backend for status updates (every 60 seconds while the user has an active session on the dashboard):
1. Backend checks Redis cache first
2. If cache miss, queries the database for the latest submission event
3. Returns the status to the frontend
4. Frontend displays acceptance confirmation or rejection details

## Resubmission After Rejection

If a return is rejected, the user can correct the issue and resubmit:

1. **MeF returns rejection error codes** — These are specific codes (e.g., `IND-180-01` for missing IP PIN) with explanations
2. **MefAlert components** in the flow configuration match these error codes to specific screens
3. The user is directed to the relevant screen(s) to fix the issue
4. A new submission is created (new Submission ID, new SubmissionEvent records)
5. The process repeats from Step 2

### Database Schema for Resubmission
The database schema was specifically designed to handle resubmission cleanly:

```
TaxReturn (1) ──── (M) Submission (1) ──── (M) SubmissionEvent
   │                       │                        │
   │ facts (mutable,      │ facts (immutable       │ status, timestamp
   │ current state)       │ snapshot at submit)    │ (append-only log)
   │                       │                        │
   │ The working copy     │ What was actually      │ What happened to
   │ the user edits       │ sent to MeF            │ each submission
```

- **TaxReturn.facts**: The mutable, current state of the user's data
- **Submission.facts**: An immutable snapshot of facts at the moment of submission. Never modified.
- **SubmissionEvent**: An append-only log of status changes. Each event has a timestamp and status.

This design enables:
- Full reconstruction of submission history
- Attribution of time spent to specific sessions (original vs. correction)
- Compliance auditing without accessing encrypted S3 artifacts

## PDF Generation

In addition to XML, the backend generates PDF representations of tax returns:

- PDF templates are stored in `backend/src/main/resources/pdf/2024/` (76 templates for TY2024)
- The backend reads fact values and fills in the PDF form fields
- PDFs are used for:
  - User review before submission
  - Record keeping after filing
  - Print-and-mail option (for users who prefer paper filing)

PDF generation uses the same fact graph values as XML generation but maps to PDF form field coordinates rather than XML elements.

## MeF Error Handling

### Error Types

| Error Source | Description | User Experience |
|-------------|-------------|-----------------|
| **XML validation failure** | Generated XML doesn't match MeF schema | Submission blocked; backend logs the error |
| **MeF rejection** | MeF rejects the return for business rule violations | User sees MefAlert with correction instructions |
| **MeF system unavailable** | MeF is down or not accepting submissions | Submission queued for retry |
| **Network failure** | Communication failure between services | Dead letter queue; ops investigation |

### MefAlert System
MefAlerts are configured in the flow to match specific MeF error codes:
```tsx
<MefAlert mefErrorCode="IND-180-01" type="error">
  {/* Alert content directing user to enter their IP PIN */}
</MefAlert>
```

- `type="error"`: Blocks resubmission until the user fixes the issue
- `type="warning"`: Allows resubmission but warns the user to review
- MefAlerts bubble up to the checklist and data views, guiding the user to the correct screen

### Example: IND-180-01 (IP PIN)
This common rejection occurs when:
1. The user submits a return without an IP PIN
2. But the IRS has records showing they should have one
3. MeF rejects with code `IND-180-01`
4. The MefAlert on the IP PIN screen becomes active
5. The user is directed to enter their IP PIN
6. Once entered, the alert condition resolves
7. The user can resubmit

## Status Service Scaling Concerns

The team identified the Status service as a bottleneck (see `status-service-2.0.md` RFC):

### Problems
- Single pod, no autoscaling
- Every active session polls every 60 seconds
- Cross-service REST calls for status and export are the most expensive APIs (3-10 seconds)
- At 50x scale, performance would degrade significantly

### Proposed Solution (Status Service 2.0)
Deprecate the Status service's endpoints entirely and rely on the Backend database + Redis cache:
- Eliminate cross-service REST calls
- Use the Backend's horizontal autoscaling (up to 96 pods)
- Cache status in Redis with TTL
- The Status service would only poll MeF, not serve status queries

This is an important architectural lesson: centralized bottleneck services that sit in the critical path should be avoided or designed for horizontal scaling from the start.

## EFIN and Submission ID Format

MeF submission IDs follow a specific format that includes:
- **EFIN** (Electronic Filing Identification Number): Identifies the authorized e-file provider
- **Variable characters**: Two configurable characters (set via `SUBMIT_ID_VAR_CHARS`)
- **Timestamp and sequence**: Additional characters for uniqueness

The EFIN, ETIN (Electronic Transmitter Identification Number), and ASID (Application System Identification) are credentials that authorize DirectFile to submit to MeF. These are stored as environment variables and are different for submit and status services.
